<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾®å…‰è¨ˆç•«ï¼šå¾©æ­¸æ—…ç¨‹ (v2.0 å¹³è¡¡ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #1a1a1d;
            --panel-color: #2b2b2e;
            --text-color: #e0e0e0;
            --accent-color: #4ecca3;
            --danger-color: #e23e57;
            --warning-color: #fce38a;
            --info-color: #3498db;
            --muted-color: #95a5a6;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }

        .game-container {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            gap: 20px;
            width: 95%;
            max-width: 1400px;
            height: 92vh;
            background-color: #000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* å·¦å´ï¼šæ•¸å€¼ */
        .stats-panel {
            background-color: var(--panel-color);
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .avatar-box {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .avatar {
            font-size: 3rem;
            margin-bottom: 5px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .stat-group {
            margin-bottom: 8px;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .progress-bg {
            width: 100%;
            height: 10px;
            background-color: #444;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        /* ä¸­é–“ï¼šä¸»æ§å° */
        .main-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .log-area {
            flex: 1;
            background-color: var(--panel-color);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            font-size: 0.95rem;
            line-height: 1.5;
            scroll-behavior: smooth;
            border-left: 4px solid var(--accent-color);
        }

        .log-entry {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-entry.event {
            color: var(--warning-color);
            border-left: 3px solid var(--warning-color);
            padding-left: 10px;
            background: rgba(252, 227, 138, 0.05);
        }

        .log-entry.danger {
            color: var(--danger-color);
            font-weight: bold;
        }

        .log-entry.success {
            color: var(--accent-color);
        }

        .log-entry.system {
            color: var(--muted-color);
            font-size: 0.85rem;
            text-align: center;
            border-bottom: none;
            margin-top: 20px;
            font-style: italic;
        }

        .log-tip {
            font-size: 0.8rem;
            color: #bbb;
            margin-top: 4px;
            display: block;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* AP é¡¯ç¤ºå€ */
        .ap-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .ap-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #333;
            border: 2px solid #555;
            transition: all 0.3s;
        }

        .ap-dot.active {
            background-color: var(--warning-color);
            border-color: #f1c40f;
            box-shadow: 0 0 10px var(--warning-color);
        }

        .action-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: auto;
            flex-shrink: 0;
        }

        button {
            background-color: #333;
            border: 1px solid #555;
            color: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        button:hover:not(:disabled) {
            background-color: #444;
            transform: translateY(-2px);
            border-color: var(--accent-color);
        }

        button:active:not(:disabled) {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        button strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        button .sub {
            font-size: 0.75rem;
            color: var(--muted-color);
        }

        /* çµç®—æŒ‰éˆ• (ç•¶ AP=0 æ™‚å‡ºç¾) */
        #next-turn-btn {
            background-color: var(--accent-color);
            color: #000;
            font-weight: bold;
            grid-column: span 2;
            display: none;
            /* åˆå§‹éš±è— */
            animation: pulse 1.5s infinite;
        }

        #next-turn-btn .sub {
            color: #000;
            opacity: 0.8;
        }

        @keyframes pulse {
            0% {
                opacity: 0.9;
            }

            50% {
                opacity: 1;
                transform: scale(1.02);
            }

            100% {
                opacity: 0.9;
            }
        }

        /* å³å´ï¼šç‹€æ…‹åˆ—è¡¨ */
        .status-panel {
            background-color: var(--panel-color);
            padding: 15px;
            border-radius: 8px;
            overflow-y: auto;
        }

        .status-header {
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
            margin-bottom: 10px;
            color: var(--info-color);
        }

        .status-item {
            background: #222;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #555;
            cursor: pointer;
            transition: background 0.2s;
        }

        .status-item:hover {
            background: #2a2a2a;
        }

        .status-item.debuff {
            border-color: var(--danger-color);
        }

        .status-item.buff {
            border-color: var(--accent-color);
        }

        .status-item.neutral {
            border-color: var(--info-color);
        }

        .status-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-name {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .status-dur {
            font-size: 0.75rem;
            background: #444;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .status-desc {
            display: none;
            font-size: 0.8rem;
            color: #ccc;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #444;
            line-height: 1.4;
        }

        .status-item.expanded .status-desc {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* RWD */
        @media (max-width: 900px) {
            .game-container {
                grid-template-columns: 1fr;
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                height: auto;
            }

            .stats-panel {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                justify-content: space-between;
                padding: 10px;
            }

            .avatar-box {
                margin: 0;
                padding: 0;
                border: none;
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #444;
                padding-bottom: 5px;
                margin-bottom: 5px;
            }

            .stat-group {
                width: 48%;
            }

            .main-panel {
                flex: 1;
                min-height: 450px;
            }

            .status-panel {
                max-height: 300px;
            }
        }

        /* çµç®—ç•«é¢ (Modal) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--panel-color);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 2rem;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .modal-desc {
            font-size: 1.1rem;
            color: #ddd;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
        }

        .modal-stat-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .modal-stat-val {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
        }
    </style>
</head>

<body>

    <div class="game-container">
        <div class="stats-panel">
            <div class="avatar-box">
                <div style="text-align: left;">
                    <div style="font-size:0.8rem; color:#aaa;">CURRENT MONTH</div>
                    <div style="font-size:1.5rem; font-weight:bold; color:var(--accent-color);">ç¬¬ <span
                            id="turn-display">1</span> æœˆ</div>
                </div>
                <div class="avatar" id="avatar">ğŸ˜</div>
            </div>

            <div class="stat-group">
                <div class="stat-label"><span>ğŸ§  æ„å¿— / ç†æ™º</span> <span id="val-sanity">60</span></div>
                <div class="progress-bg">
                    <div class="progress-fill" id="bar-sanity" style="width: 60%; background: var(--danger-color);">
                    </div>
                </div>
            </div>

            <div class="stat-group">
                <div class="stat-label"><span>ğŸ¤ ç¤¾æœƒé€£çµ</span> <span id="val-social">40</span></div>
                <div class="progress-bg">
                    <div class="progress-fill" id="bar-social" style="width: 40%; background: var(--info-color);"></div>
                </div>
            </div>

            <div class="stat-group">
                <div class="stat-label"><span>ğŸ’° ç¶“æ¿Ÿå­˜æ¬¾</span> <span id="val-money"
                        style="color:var(--warning-color);">$5000</span></div>
            </div>

            <div style="margin-top:auto; font-size:0.8rem; color:#666; text-align:center;">
                æ¯æœˆç”Ÿæ´»æˆæœ¬: -$2,500
            </div>
        </div>

        <div class="main-panel">
            <div class="log-area" id="log-display">
                <div class="log-entry system">
                    æ­¡è¿ä¾†åˆ°ã€Šå¾®å…‰è¨ˆç•«ã€‹ã€‚<br>
                    æ¯å€‹æœˆä½ æœ‰ 3 å€‹è¡Œå‹•é»æ•¸ (AP)ã€‚<br>
                    è«‹è¬¹æ…åˆ†é…å·¥ä½œã€ç¤¾äº¤èˆ‡é†«ç™‚ï¼Œæ’éé€™ä¸€å¹´ã€‚
                </div>
            </div>

            <div class="ap-container" id="ap-dots">
                <div class="ap-dot active"></div>
                <div class="ap-dot active"></div>
                <div class="ap-dot active"></div>
            </div>

            <div class="action-area" id="action-buttons">
                <button onclick="performAction('work')">
                    <strong>ğŸ’¼ æ‰“å·¥å…¼è·</strong>
                    <span class="sub">+$800~1200 | -5 ç†æ™º</span>
                </button>
                <button onclick="performAction('connect')">
                    <strong>ğŸ’¬ ç¤¾äº¤è¯ç¹«</strong>
                    <span class="sub">+é€£çµ | +5 ç†æ™º | -3 AP</span>
                </button>
                <button onclick="performAction('medical')">
                    <strong>ğŸ¥ å¿ƒç†è«®å•†</strong>
                    <span class="sub">-$800 | +20 ç†æ™º | é™¤ç‹€æ…‹</span>
                </button>
                <button onclick="performAction('hide')">
                    <strong>ğŸ  ä¼‘æ¯ç¨è™•</strong>
                    <span class="sub">+5 ç†æ™º | ç„¡èŠ±è²»</span>
                </button>

                <button id="next-turn-btn" onclick="endMonth()">
                    <strong>ğŸŒ™ çµç®—æœ¬æœˆ (Next Month)</strong>
                    <span class="sub">æ”¯ä»˜æˆ¿ç§Ÿ -> è§¸ç™¼äº‹ä»¶ -> æ¢å¾© AP</span>
                </button>
            </div>
        </div>

        <div class="status-panel">
            <div class="status-header">ç•¶å‰èº«å¿ƒç‹€æ…‹ (Status)</div>
            <div id="status-list"></div>
        </div>
    </div>

    <!-- çµç®—ç•«é¢ Modal -->
    <div id="game-over-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title" id="modal-title">éŠæˆ²çµæŸ</div>
            <div class="modal-desc" id="modal-desc">å…§å®¹èªªæ˜...</div>

            <div class="modal-stats">
                <div class="modal-stat-item">
                    <span>æœ€çµ‚ç†æ™º</span>
                    <span class="modal-stat-val" id="end-sanity">0</span>
                </div>
                <div class="modal-stat-item">
                    <span>æœ€çµ‚å­˜æ¬¾</span>
                    <span class="modal-stat-val" id="end-money">0</span>
                </div>
                <div class="modal-stat-item">
                    <span>å­˜æ´»æœˆä»½</span>
                    <span class="modal-stat-val" id="end-turn">1</span>
                </div>
            </div>

            <button onclick="location.reload()" style="width:100%; background:var(--accent-color); color:#000;">
                <strong>ğŸ”„ é‡æ–°é–‹å§‹</strong>
            </button>
        </div>
    </div>

    <script>
        // --- 1. æ•¸æ“šåº« ---

        const effectDB = {
            'stigma': { name: 'è‡ªæˆ‘æ±¡å', type: 'debuff', desc: 'è¦ºå¾—ä½äººä¸€ç­‰ã€‚ç¤¾äº¤æ•ˆæœæ¸›åŠã€‚', onTurn: (lvl) => ({ sanity: -2 * lvl }) },
            'anxiety': { name: 'å»£æ³›æ€§ç„¦æ…®', type: 'debuff', desc: 'å°æœªä¾†çš„ææ‡¼ã€‚å·¥ä½œæ”¶å…¥ä¸ç©©ã€‚', onTurn: (lvl) => ({ sanity: -3 * lvl }) },
            'shame': { name: 'ç¾æ¥æ„Ÿ', type: 'debuff', desc: 'å…§åŒ–çš„ç½ªæƒ¡æ„Ÿã€‚', onTurn: (lvl) => ({ social: -2 * lvl }) },
            'numb': { name: 'æƒ…æ„Ÿéº»æœ¨', type: 'neutral', desc: 'é—œé–‰æ„ŸçŸ¥ã€‚ç¤¾äº¤ç„¡æ•ˆã€‚', onTurn: (lvl) => ({ social: -5 }) },
            'withdrawal': { name: 'æˆ’æ–·åæ‡‰', type: 'debuff', desc: 'èº«é«”åœ¨å°–å«ã€‚æ¥µåº¦å±éšªã€‚', onTurn: (lvl) => ({ sanity: -8 * lvl }) },
            'insomnia': { name: 'åš´é‡å¤±çœ ', type: 'debuff', desc: 'è—¥ç‰©å²é€ æˆçš„ç¡çœ éšœç¤™ã€‚', onTurn: (lvl) => ({ sanity: -4 }) },
            'pain': { name: 'æ…¢æ€§ç–¼ç—›', type: 'debuff', desc: 'èº«é«”ç–¼ç—›ã€‚', onTurn: (lvl) => ({ sanity: -2 }) },
            'suspicion': { name: 'è·å ´ç–‘æ…®', type: 'debuff', desc: 'ä¸»ç®¡è¦ºå¾—ä½ æ€ªæ€ªçš„ã€‚', onTurn: (lvl) => ({ money: -200 * lvl, sanity: -2 }) },
            'monitored': { name: 'é«˜å£“ç›£æ§', type: 'debuff', desc: 'å®¶äººç›¯å¾—å¾ˆç·Šã€‚', onTurn: (lvl) => ({ sanity: -3 }) },
            'trust': { name: 'ä¿¡ä»»é€£çµ', type: 'buff', desc: 'æœ‰äººé¡˜æ„ç›¸ä¿¡ä½ ã€‚', onTurn: (lvl) => ({ sanity: +2 * lvl }) },
            'stable_job': { name: 'ç©©å®šå°±æ¥­', type: 'buff', desc: 'å·¥ä½œå¸¶ä¾†æˆå°±æ„Ÿã€‚', onTurn: (lvl) => ({ money: +200, sanity: +1 }) },
            'imposter': { name: 'å†’ç‰Œè€…ç—‡å€™ç¾¤', type: 'debuff', desc: 'å®³æ€•è¢«è­˜ç ´èº«åˆ†ã€‚', onTurn: (lvl) => ({ sanity: -3 }) }
        };

        const eventsPool = [
            { text: "å…¬å¸èšé¤ç©ç¬‘ï¼šã€Œå¸æ¯’çš„äººéƒ½è©²æ­»åˆ‘ã€‚ã€", result: "ä½ åªèƒ½é™ªç¬‘ï¼Œå…§å¿ƒææ‡¼ã€‚", effect: () => { addEffect('imposter', 2, 1); changeStat('sanity', -5); } },
            { text: "HR è¦æ±‚è£œäº¤è‰¯æ°‘è­‰ã€‚", result: "ä½ ç·¨è—‰å£æ‹–å»¶ï¼Œç„¦æ…®å¤±çœ ã€‚", effect: () => { addEffect('anxiety', 3, 1); addEffect('insomnia', 2, 1); } },
            { text: "å®¶äººæ‡·ç–‘ä½ å¾©ç™¼ï¼ˆå› ç‚ºä½ å¸¸è·‘é†«é™¢ï¼‰ã€‚", result: "è¢«è¿«èªªè¬Šï¼Œä¿¡ä»»ç ´è£‚ã€‚", effect: () => { addEffect('monitored', 4, 1); changeStat('social', -10); } },
            { text: "æ·é‹é‡è‡¨æª¢ã€‚", result: "å‰µå‚·åæ‡‰è®“ä½ å…¨èº«åƒµç¡¬ã€‚", effect: () => { changeStat('sanity', -10); addEffect('shame', 2, 1); } },
            { text: "ç”¨è—¥å¤¢ (Using Dream)ï¼šå¤¢è¦‹ä»¥å‰çš„å¿«æ„Ÿã€‚", result: "é†’ä¾†å…¨æ˜¯å†·æ±—ï¼Œæ¸´æœ›å¼·çƒˆã€‚", effect: () => { addEffect('withdrawal', 1, 1); changeStat('sanity', -10); } },
            { text: "ç‰™é½¦è…«ç—›ç™¼ä½œã€‚", result: "èŠ±äº†ä¸€ç­†é†«è—¥è²»ã€‚", effect: () => { addEffect('pain', 2, 1); changeStat('money', -1000); } },
            { text: "è«åçš„ç©ºè™›ç„¡èŠã€‚", result: "å¥½æƒ³æ‰¾é»åˆºæ¿€ã€‚", effect: () => { changeStat('sanity', -5); } },
            { text: "è—¥é ­ç°¡è¨Šï¼šã€Œæœ‰æ–°è²¨ã€‚ã€", result: "æ‰‹æŒ‡åœ¨å°é–éµä¸Šé¡«æŠ–ã€‚", effect: () => { addEffect('withdrawal', 2, 1); changeStat('sanity', -15); } },
            { text: "åŒå­¸æœƒçš„ç¤¾æœƒæ¯”è¼ƒã€‚", result: "è¦ºå¾—è‡ªå·±äººç”Ÿæ¯€äº†ã€‚", effect: () => { addEffect('stigma', 3, 1); } },
            { text: "è§€è­·äººå ±åˆ°è¡å ‚ï¼Œè¢«è¿«è«‹å‡ã€‚", result: "ä¸»ç®¡è‡‰è‰²é›£çœ‹ã€‚", effect: () => { addEffect('suspicion', 2, 1); } },
            { text: "äº¤å‹è»Ÿé«”è¢«å•ï¼šã€Œç©ºç™½é‚£ä¸€å¹´å»å“ªäº†ï¼Ÿã€", result: "åš‡å¾—è§£é™¤é…å°ã€‚", effect: () => { changeStat('social', -5); addEffect('anxiety', 2, 1); } },
            { text: "é¤µäº†ä¸€éš»æµæµªè²“ã€‚", result: "å¿ƒæƒ…å¹³éœäº†è¨±å¤šã€‚", effect: () => { changeStat('sanity', +10); } },
            { text: "å€‹ç®¡å¸«æ‰“é›»è©±ä¾†é—œå¿ƒã€‚", result: "è¦ºå¾—ä¸æ˜¯å­¤è»å¥®æˆ°ã€‚", effect: () => { changeStat('sanity', +5); addEffect('trust', 1, 1); } },
            { text: "è€é—†ç™¼äº†ä¸€é»å°çé‡‘ã€‚", result: "è¢«è‚¯å®šçš„æ„Ÿè¦ºã€‚", effect: () => { changeStat('money', +1000); addEffect('stable_job', 3, 1); removeEffect('suspicion'); } },
            { text: "åƒåŠ äº’åŠ©æœƒ (NA)ã€‚", result: "ç™¼ç¾è‡ªå·±ä¸å­¤å–®ã€‚", effect: () => { removeEffect('shame'); changeStat('sanity', +15); } },
            { text: "æˆ¿æ±æ¼²ç§Ÿã€‚", result: "ç”Ÿå­˜å£“åŠ›å€å¢ã€‚", effect: () => { changeStat('money', -1500); changeStat('sanity', -5); } },
            { text: "å¡å‚µå¼·åˆ¶æ‰£è–ªã€‚", result: "çµ•æœ›æ„Ÿã€‚", effect: () => { changeStat('money', -2000); addEffect('anxiety', 2, 1); } },
            { text: "æ©Ÿè»Šå£äº†ã€‚", result: "ç¶­ä¿®è²»è®“ä½ èµ¤å­—ã€‚", effect: () => { changeStat('money', -1000); } },
            { text: "æ”¶åˆ°æ³•é™¢è­‰äººå‚³ç¥¨ã€‚", result: "è™›é©šä¸€å ´ä½†å¾ˆç´¯ã€‚", effect: () => { changeStat('sanity', -5); } },
            { text: "é‡è¦‹å‹å–„ç¤¾å·¥ã€‚", result: "ä¸–ç•Œé‚„æ˜¯æœ‰æº«åº¦çš„ã€‚", effect: () => { changeStat('sanity', +10); changeStat('social', +5); } }
        ];

        // --- 2. éŠæˆ²é‚è¼¯ ---

        let gameState = {
            turn: 1,
            maxTurns: 12,
            sanity: 60,
            social: 40,
            money: 5000,
            ap: 3,         // ç•¶å‰ AP
            maxAp: 3,      // æœ€å¤§ AP
            costOfLiving: 2500, // æ¯æœˆå›ºå®šæ”¯å‡º (å·²ä¸‹èª¿)
            activeEffects: []
        };

        // åˆå§‹åŒ–
        addEffect('imposter', 12, 1);
        updateUI();

        function changeStat(type, val) {
            gameState[type] += val;
            if (type === 'sanity') gameState.sanity = Math.min(100, gameState.sanity);
            if (type === 'social') gameState.social = Math.min(100, Math.max(0, gameState.social));
        }

        function addEffect(id, dur, lvl = 1) {
            let existing = gameState.activeEffects.find(e => e.id === id);
            if (existing) {
                existing.duration = Math.max(existing.duration, dur);
                existing.level += lvl;
            } else {
                gameState.activeEffects.push({ id: id, duration: dur, level: lvl });
            }
            updateStatusList();
        }

        function removeEffect(id) {
            gameState.activeEffects = gameState.activeEffects.filter(e => e.id !== id);
            updateStatusList();
        }

        function hasEffect(id) { return gameState.activeEffects.some(e => e.id === id); }

        // --- è¡Œå‹•ç³»çµ± ---

        function performAction(type) {
            if (gameState.ap <= 0) return;

            let logText = "";
            let risk = Math.random();

            // æ‰£é™¤ AP
            gameState.ap--;

            if (type === 'work') {
                // å¹³è¡¡èª¿æ•´ï¼šå·¥ä½œæ”¶å…¥ $800-1200ï¼Œæ‰£ç†æ™º 5-8
                let income = 800 + Math.floor(Math.random() * 400);
                let sanityCost = 5 + Math.floor(Math.random() * 3);

                // ç‹€æ…‹å½±éŸ¿
                if (hasEffect('suspicion')) { income -= 200; sanityCost += 2; }
                if (hasEffect('anxiety')) { sanityCost += 2; }
                if (hasEffect('stable_job')) { income += 200; sanityCost -= 2; }

                if (risk < 0.1) { // 10% æ©Ÿç‡æç ¸
                    logText = "å·¥ä½œæç¥çŠ¯éŒ¯ï¼Œè¢«ä¸»ç®¡ç½µäº†ã€‚";
                    changeStat('sanity', -10);
                    addEffect('suspicion', 2, 1);
                    changeStat('money', income);
                } else {
                    logText = `æ‰“å·¥çµæŸï¼Œè³ºäº† $${income}ã€‚`;
                    changeStat('sanity', -sanityCost);
                    changeStat('money', income);
                    if (risk > 0.9) addEffect('stable_job', 2, 1);
                }
            }
            else if (type === 'connect') {
                // ç¤¾äº¤ä¸èŠ±éŒ¢ï¼Œå›ç†æ™ºï¼Œå›é€£çµ
                if (hasEffect('stigma') || hasEffect('shame')) {
                    if (risk < 0.5) {
                        logText = "è©¦åœ–è¯ç¹«æœ‹å‹ï¼Œä½†è¦ºå¾—è‡ªå·±ä¸é…ï¼Œåˆæ›æ–·äº†ã€‚";
                        changeStat('sanity', -2);
                    } else {
                        logText = "é›–ç„¶å°·å°¬ï¼Œä½†é‚„æ˜¯å’Œå®¶äººåƒäº†é£¯ã€‚";
                        changeStat('social', +8);
                        changeStat('sanity', +2);
                    }
                } else {
                    logText = "å’Œæœ‹å‹èŠå¤©ï¼Œå¿ƒæƒ…æ”¾é¬†ã€‚";
                    changeStat('sanity', +8);
                    changeStat('social', +10);
                    addEffect('trust', 2, 1);
                }
            }
            else if (type === 'medical') {
                // é†«ç™‚èŠ±è²» $800 (ä¸‹èª¿)ï¼Œå›ç†æ™º +20
                if (gameState.money < 800) {
                    addLog("å­˜æ¬¾ä¸è¶³ ($800)ï¼Œç„¡æ³•æ”¯ä»˜æ›è™Ÿè²»ã€‚", "danger");
                    gameState.ap++; // é€€å› AP
                    return;
                }
                changeStat('money', -800);
                changeStat('sanity', +20);

                removeEffect('withdrawal');
                removeEffect('insomnia');
                if (hasEffect('anxiety')) removeEffect('anxiety');
                logText = "é€²è¡Œäº†å¿ƒç†è«®å•†èˆ‡è—¥ç‰©èª¿æ•´ã€‚ç„¦æ…®æ„Ÿæ¸›è¼•äº†ã€‚";
            }
            else if (type === 'hide') {
                // ä¼‘æ¯å›ç†æ™º +5ï¼Œç„¡èŠ±è²»
                changeStat('sanity', +5);
                addEffect('numb', 2, 1);
                logText = "æŠŠè‡ªå·±é—œåœ¨æˆ¿é–“ä¼‘æ¯ï¼Œæš«æ™‚é€ƒé¿ä¸–ç•Œã€‚";
            }

            addLog(logText);
            updateUI();
        }

        // --- æœˆçµç®—ç³»çµ± ---

        function endMonth() {
            addLog(`--- ç¬¬ ${gameState.turn} æœˆ çµç®— ---`, "system");

            // 1. æ‰£ç”Ÿæ´»è²»
            changeStat('money', -gameState.costOfLiving);
            addLog(`æ”¯ä»˜æœ¬æœˆç”Ÿæ´»è²»èˆ‡æˆ¿ç§Ÿ -$${gameState.costOfLiving}ã€‚`);

            // 2. ç‹€æ…‹æ•ˆæœçµç®—
            processTurnEffects();

            // 3. éš¨æ©Ÿäº‹ä»¶ (40% æ©Ÿç‡)
            if (gameState.sanity > 0 && Math.random() < 0.4) {
                triggerRandomEvent();
            }

            // 4. æº–å‚™ä¸‹å€‹æœˆ
            gameState.turn++;
            gameState.ap = gameState.maxAp; // é‡ç½® AP

            checkGameOver();
            updateUI();
        }

        function processTurnEffects() {
            gameState.activeEffects.forEach(e => {
                let db = effectDB[e.id];
                let diff = db.onTurn(e.level);
                if (diff.sanity) changeStat('sanity', diff.sanity);
                if (diff.social) changeStat('social', diff.social);
                if (diff.money) changeStat('money', diff.money);
                e.duration--;
            });
            gameState.activeEffects = gameState.activeEffects.filter(e => e.duration > 0);
        }

        function triggerRandomEvent() {
            let evt = eventsPool[Math.floor(Math.random() * eventsPool.length)];
            addLog(evt.text, "event");
            addLog(`çµæœï¼š${evt.result}`, "danger");
            evt.effect();
        }

        function updateUI() {
            document.getElementById('turn-display').innerText = gameState.turn;
            document.getElementById('val-sanity').innerText = Math.floor(gameState.sanity);
            document.getElementById('bar-sanity').style.width = Math.max(0, gameState.sanity) + "%";
            document.getElementById('val-social').innerText = Math.floor(gameState.social);
            document.getElementById('bar-social').style.width = Math.max(0, gameState.social) + "%";

            let moneyEl = document.getElementById('val-money');
            moneyEl.innerText = `$${gameState.money}`;
            moneyEl.style.color = gameState.money < 0 ? 'red' : '#fce38a';

            // AP é»æ•¸è¦–è¦ºåŒ–
            const apDots = document.querySelectorAll('.ap-dot');
            apDots.forEach((dot, idx) => {
                dot.classList.toggle('active', idx < gameState.ap);
            });

            // æŒ‰éˆ•ç‹€æ…‹æ§åˆ¶
            const btns = document.querySelectorAll('#action-buttons button:not(#next-turn-btn)');
            const nextBtn = document.getElementById('next-turn-btn');

            if (gameState.ap <= 0) {
                btns.forEach(b => b.disabled = true);
                nextBtn.style.display = 'block'; // é¡¯ç¤ºçµç®—æŒ‰éˆ•
            } else {
                btns.forEach(b => b.disabled = false);
                nextBtn.style.display = 'none';
            }

            // é ­åƒ
            let av = document.getElementById('avatar');
            if (gameState.sanity > 80) av.innerText = "ğŸ™‚";
            else if (gameState.sanity > 50) av.innerText = "ğŸ˜";
            else if (gameState.sanity > 20) av.innerText = "ğŸ˜°";
            else av.innerText = "ğŸ§Ÿ";

            updateStatusList();
        }

        function updateStatusList() {
            let container = document.getElementById('status-list');
            container.innerHTML = "";
            if (gameState.activeEffects.length === 0) {
                container.innerHTML = "<div style='color:#666; font-style:italic;'>ç„¡ç‰¹æ®Šç‹€æ…‹</div>";
                return;
            }
            gameState.activeEffects.forEach(e => {
                let db = effectDB[e.id];
                let el = document.createElement('div');
                el.className = `status-item ${db.type}`;
                el.onclick = function () { this.classList.toggle('expanded'); };
                el.innerHTML = `
                    <div class="status-top">
                        <span class="status-name">${db.name} ${e.level > 1 ? 'Lv' + e.level : ''}</span>
                        <span class="status-dur">${e.duration}æœˆ</span>
                    </div>
                    <div class="status-desc">${db.desc}</div>
                `;
                container.appendChild(el);
            });
        }

        function addLog(text, type = "normal") {
            let div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerText = text;
            let area = document.getElementById('log-display');
            area.prepend(div);
        }

        function checkGameOver() {
            let isGameOver = false;
            let title = "";
            let desc = "";
            let type = "bad"; // bad or good

            // æ¢ä»¶ 1: ç†æ™ºæ­¸é›¶
            if (gameState.sanity <= 0) {
                isGameOver = true;
                title = "ã€Bad Endã€‘ç†æ™ºå´©æ½°";
                desc = "ä½ çš„ç²¾ç¥å†ä¹Ÿç„¡æ³•æ‰¿å—ç¾å¯¦çš„é‡å£“ã€‚åœ¨ç„¡åŠ©èˆ‡ç—›è‹¦ä¸­ï¼Œä½ é¸æ“‡äº†æœ€å±éšªçš„é€ƒé¿æ–¹å¼â€”â€”å¾©ç™¼ ODã€‚<br><br>é€™ä¸€æ¬¡ï¼Œæˆ–è¨±çœŸçš„å›ä¸ä¾†äº†ã€‚";
                type = "bad";
            }
            // æ¢ä»¶ 2: è³‡é‡‘ <= -5000 (ç ´ç”¢)
            else if (gameState.money <= -5000) {
                isGameOver = true;
                title = "ã€Bad Endã€‘ç¤¾æœƒæ€§æ­»äº¡";
                desc = "å‚µå‹™å¦‚é›ªçƒèˆ¬è¶Šæ»¾è¶Šå¤§ã€‚æˆ¿æ±å°‡ä½ è¶•å‡ºé–€ï¼ŒéŠ€è¡Œå‡çµäº†å¸³æˆ¶ï¼Œä½ è¢«è¿«æµè½è¡—é ­ã€‚<br><br>åœ¨é€™ç¨®æ¥µç«¯ç’°å¢ƒä¸‹ï¼Œå¾©æ­¸ç¤¾æœƒæˆäº†ä¸€å ´é†’ä¸éä¾†çš„å¤¢ã€‚";
                type = "bad";
            }
            // æ¢ä»¶ 3: æ’é 12 å€‹æœˆ
            else if (gameState.turn > gameState.maxTurns) {
                isGameOver = true;
                title = "ã€Good Endã€‘å¾®å…‰ä¸­çš„é»æ˜";
                desc = "ä¸€å¹´éå»äº†ã€‚é›–ç„¶ç”Ÿæ´»ä¾ç„¶å……æ»¿æŒ‘æˆ°ï¼Œå‚·å£ä¹Ÿå¶çˆ¾æœƒéš±éš±ä½œç—›ï¼Œä½†ä½ æ´»ä¸‹ä¾†äº†ã€‚<br><br>ä½ æ‰¾å›äº†ä¸€é»å°æœªä¾†çš„æŒæ§æ„Ÿã€‚é€™å°±æ˜¯å¾©æ­¸æ—…ç¨‹çš„ç¬¬ä¸€æ­¥ã€‚";
                type = "good";
            }

            if (isGameOver) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-desc').innerHTML = desc;

                // è¨­å®šé¡è‰²
                let titleEl = document.getElementById('modal-title');
                if (type === 'good') titleEl.style.color = 'var(--accent-color)';
                else titleEl.style.color = 'var(--danger-color)';

                document.getElementById('end-sanity').innerText = Math.floor(gameState.sanity);
                document.getElementById('end-money').innerText = "$" + gameState.money;
                document.getElementById('end-turn').innerText = Math.min(gameState.turn, 12); // é˜²æ­¢é¡¯ç¤º 13 æœˆ

                document.getElementById('game-over-modal').style.display = "flex";
            }
        }

        // ä¿®æ”¹ updateUI ä»¥åŒ…å«éŠæˆ²çµæŸæª¢æŸ¥
        const _originalUpdateUI = updateUI;
        updateUI = function () {
            _originalUpdateUI();
            checkGameOver();
        };
    </script>
</body>

</html>